---
layout: post
title: Parsing large XML files in Python
categories: Work
---

*lxml* is an easy-to-use library for processing XML and HTML in Python. It is built on top of two C libraries (*libxml2* and *libxslt*) and proves high-performance characteristics. However, when dealing with very large files it eventually consumes all my system's available memory and then the process is killed. This is due to the parse method which reads the entire document and builds an in-memory tree, storing each nodes' context. 

I found a solution based upon iterative parsing in [this article](https://www.ibm.com/developerworks/xml/library/x-hiperfparse/) published by Liza Daly. It presents diverse techniques to efficiently process very large XML files, optimizing for high speed and low memory usage. An iterative parsing technique does not rely on reading the entire source file. Two different approaches are exposed: the target parser method and the *lxml iterparse* method. I opted for the latter since only a few tags were of interest and *iterparse* outperforms the target parser method in that particular case. 

In the referenced [article](https://www.ibm.com/developerworks/xml/library/x-hiperfparse/), the author proposes an optimized *iterparse* approach (named *fast_iter*) which free the references to nodes at the end of each loop, including both references to children or text nodes that were already been processed and preceding siblings of the current node.

---

This example is adapted to extract the part-of-speech (POS) tagging from a given XML file, generated by FreeLing[^fn-sample_footnote]. As we can see in the following snippet from the file, we are given a lot of grammatical information related to a word, but we are interested in the `tag` attribute only. 

```xml
<sentence id="1">
  <token id="t1.1" form="When" lemma="when" tag="NP00000" ctag="NP" pos="noun" type="proper" ></token>
  <token id="t1.2" form="shall" lemma="shall" tag="NCMS000" ctag="NC" pos="noun" type="common" gen="masculine" num="singular" ></token>
  <token id="t1.3" form="we" lemma="we" tag="RG" ctag="RG" pos="adverb" type="general" ></token>
  <token id="t1.4" form="three" lemma="three" tag="VMIP3S0" ctag="VMI" pos="verb" type="main" mood="indicative" tense="present" person="3" num="singular" ></token>
  <token id="t1.5" form="meet" lemma="meet" tag="NCMS000" ctag="NC" pos="noun" type="common" gen="masculine" num="singular" ></token>
  <token id="t1.6" form="again" lemma="again" tag="NCMS000" ctag="NC" pos="noun" type="common" gen="masculine" num="singular" ></token>
  <token id="t1.7" form="In" lemma="in" tag="NP00000" ctag="NP" pos="noun" type="proper" ></token>
  <token id="t1.8" form="thunder" lemma="thunder" tag="VMN0000" ctag="VMN" pos="verb" type="main" mood="infinitive" ></token>
  <token id="t1.9" form="," lemma="," tag="Fc" ctag="Fc" pos="punctuation" type="comma" ></token>
  <token id="t1.10" form="lightning" lemma="lightning" tag="NCMS000" ctag="NC" pos="noun" type="common" gen="masculine" num="singular" ></token>
  <token id="t1.11" form="," lemma="," tag="Fc" ctag="Fc" pos="punctuation" type="comma" ></token>
  <token id="t1.12" form="or" lemma="or" tag="NCMS000" ctag="NC" pos="noun" type="common" gen="masculine" num="singular" ></token>
  <token id="t1.13" form="in" lemma="in" tag="RG" ctag="RG" pos="adverb" type="general" ></token>
  <token id="t1.14" form="rain" lemma="rain" tag="NCMS000" ctag="NC" pos="noun" type="common" gen="masculine" num="singular" ></token>
  <token id="t1.15" form="?" lemma="?" tag="Fit" ctag="Fit" pos="punctuation" type="questionmark" punctenclose="close" ></token>
</sentence>
```

Working code in Python 2.7 (see References):

```python
class readXML():
    def __init__(self):
        self.tag_dict = {}
        self.counter = 0

    def _set_up_context(self, xmlfile):
        return etree.iterparse(xmlfile, tag='token', events=('end', ))

    def get_results(self):
        return self.tag_dict

    # In order to free some memory as you parse:
    def fast_iter(self, xmlfile, attribute):
        """
        Based on Liza Daly's fast_iter:
        http://www.ibm.com/developerworks/xml/library/x-hiperfparse/
        """
        context = self._set_up_context(xmlfile)
        for _, elem in context:
            self._parse_xml(elem, attribute)
            # It's safe to call clear() here because no descendants will be accessed
            elem.clear()
            # Also eliminate now-empty references from the root node to elem
            for ancestor in elem.xpath('ancestor-or-self::*'):
                while ancestor.getprevious() is not None:
                    del ancestor.getparent()[0]
        del context
        print("%d different pos tag found" % len(self.tag_dict))
        print("%d words with more than one grammatical value" % self.counter)

    def _parse_xml(self, elem, attribute):
        value = elem.attrib.get(attribute)
        if elem.attrib['lemma'] in self.tag_dict: 
        # Word already stored in dictionary
            if elem.attrib.get(attribute) == value: 
            	# Same POS tag
                return
            else:
            	# Add new grammatical information
                self.tag_dict[elem.attrib['lemma']].append(value)  
                self.counter += 1
        else:
            self.tag_dict[elem.attrib['lemma']] = [value]
```

So the main method could be as following:

```python
if __name__ == "__main__":
# Define input arguments
    parser = argparse.ArgumentParser()
    parser.add_argument('-xml', help='XML file to be parsed', dest='xml', required=True)
    parser.add_argument('-out', help='Path to the output variable', dest='out', required=True)
    parser.add_argument('-attrib', help='Attribute to be extracted', dest='atr', default='tag')
    args = parser.parse_args()

    # Parse the XML file
    reader = readXML()
    reader.fast_iter(args.xml, args.atr)
    postag_dict = reader.get_results()
    # Save dictionary with the vocabulary and the POS tag for each word 
    cPickle.dump(postag_dict, open(args.out,"wb"))
```

### References
[Liza Day article at IBM DeveloperWorks](https://www.ibm.com/developerworks/xml/library/x-hiperfparse)

[lxml docs](http://lxml.de/parsing.html#modifying-the-tree)

[This issue on stackoverflow](https://stackoverflow.com/questions/12160418/why-is-lxml-etree-iterparse-eating-up-all-my-memory)

[^fn-sample_footnote]: Find [here](https://talp-upc.gitbooks.io/freeling-user-manual/content/index.html) the Freeling User Manual.
